<script>
window.onload = AlterOnLoad;
window.onunload = CloseWindow;

var Row;
var Token;
var Checker = "";
var MsgReceived = false;

function AlterOnLoad(){
  GetRowParameter();
  GetTokenParameter();
  var CheckerURL = "https://script.google.com/macros/s/AKfycby5U_ZWMloL8YBFliDWvAg6qbjcGSbCq1vn3G1BPNmo/dev?chk="+Token+"&Row="+Row;
  Checker = window.open(CheckerURL, "Checker", "width=400, height=200");
  if(Checker.location.href == "about:blank"){
    if(Checker!=undefined && Checker!=null){
      console.log("Has Reference!");
    }
    else console.log("Lost");
    Checker.location.href = CheckerURL;
  }
  //document.write("<object id='HGTestVersion' data='http://test.heroesandgenerals.com' width='"+window.innerWidth+"' height='"+window.innerHeight+"' style='left:0px; top:0px; margin-left:0px; margin-top:0px; position:fixed;'></object>");
  if(Checker!=undefined && Checker!=null){
    console.log("Still has reference");
  }
  else console.log("Disappeared");
}


function ReceiveMessage(e){
  var origin = e.origin || e.originalEvent.origin;
  console.log(origin);
  if(origin!=="https://script.google.com"){
    return;
  }
  var message = e.data
  console.log("Message received: "+message);
  if(!MsgReceived){
    MsgReceived = true;
    document.write("<object id='HGTestVersion' data='http://test.heroesandgenerals.com' width='"+window.innerWidth+"' height='"+window.innerHeight+"' style='left:0px; top:0px; margin-left:0px; margin-top:0px; position:fixed;'></object>");
  }
  if(message=="Close"){
    CloseWindow();
  }
}


function CloseWindow(){
  if(Checker && Checker!="" && !Checker.closed){
    Checker.close();
  }
  window.open("https://script.google.com/macros/s/AKfycby5U_ZWMloL8YBFliDWvAg6qbjcGSbCq1vn3G1BPNmo/dev?close="+Row, "_top");
}


function GetRowParameter(){
  var aux = location.search;
  aux = aux.substring(0, aux.indexOf("&"));
  Row = aux.replace("?Row=", "");
}


function GetTokenParameter(){
  var aux = location.search;
  aux = aux.substring(aux.indexOf("&"));
  Token = aux.replace("&Token=", "");
}


window.addEventListener("message", ReceiveMessage, false);
</script>
