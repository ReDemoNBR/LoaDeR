<script>
window.onload = AlterOnLoad;
window.onunload = LogOut;
var Timeout = 0;

function AlterOnLoad(){
  PingController();
}


function PingController(){
  console.log("sending message: Opening");
  window.opener.postMessage("Ping", "https://n-td7fejzwmlqmheejrvhujrb7m4phyvsuihj5jqq-script.googleusercontent.com");
}


function LogOut(){
  console.log("closing game window");
  window.opener.postMessage("Close", "https://n-td7fejzwmlqmheejrvhujrb7m4phyvsuihj5jqq-script.googleusercontent.com");
}


function Console(){
  console.log("AutoMessage Hello!");
}


function Update(){
  console.log("Timeout in "+(30-Timeout/1000)+"s");
  if(Timeout>=30000){
    console.log("Shutdown by timeout");
    window.close();
  }
  else{
    var Time = 1000;
    Timeout += Time;
    setTimeout(Update, Time);
  }
}


function ReceiveMessage(e){
  var origin = e.origin || e.originalEvent.origin;
  if(origin !== "https://n-td7fejzwmlqmheejrvhujrb7m4phyvsuihj5jqq-script.googleusercontent.com"){
    console.log("Message from bad source ignored");
    return;
  }
  var Message = e.data;
  if(Message.Command){
    if(Message.Command == "eval"){
      eval(Message.Code);
      if(Message.SecondCode){
        return eval(Message.SecondCode);
      }
      return;
    }
    return;
  }
  console.log("Message content: "+Message);
  if(Message == "Close"){
    window.close();
  }
  if(Message == "Ping"){
    Timeout = 0;
    return;
  }
}


window.addEventListener("message", ReceiveMessage, false);
</script>
